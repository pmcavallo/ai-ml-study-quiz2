<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>AI/ML Quiz — Offline (Procedural)</title>

  <!-- UI libs (no backends) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@0.468.0/dist/umd/lucide.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root { color-scheme: light dark; }
    .card { @apply bg-white/80 dark:bg-zinc-900/70 backdrop-blur rounded-2xl shadow-lg border border-zinc-200/60 dark:border-zinc-800; }
    .btn { @apply inline-flex items-center gap-2 rounded-xl px-4 py-2 font-medium border border-zinc-300 dark:border-zinc-700 hover:bg-zinc-50 dark:hover:bg-zinc-800; }
    .btn-primary { @apply bg-indigo-600 text-white border-indigo-600 hover:bg-indigo-500; }
    .chip { @apply text-xs px-2 py-0.5 rounded-full border border-zinc-300 dark:border-zinc-700; }
    .kbd { @apply inline-block rounded-lg border border-zinc-300 dark:border-zinc-700 px-1.5 py-0.5 text-xs font-mono; }
    .pop { animation: pop .22s ease-out both; }
    @keyframes pop { from { transform: scale(.97); opacity:0; } to { transform: scale(1); opacity:1; } }
    a.link { @apply text-indigo-600 underline; }
  </style>
</head>
<body class="bg-gradient-to-br from-zinc-50 to-white dark:from-zinc-950 dark:to-zinc-900 text-zinc-900 dark:text-zinc-100 min-h-screen">
  <div class="max-w-6xl mx-auto px-4 py-6">
    <!-- Header -->
    <header class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-2xl bg-indigo-600 grid place-content-center text-white font-bold">AI</div>
        <div>
          <h1 class="text-2xl font-semibold">AI/ML Quiz — Offline (Procedural)</h1>
          <p class="text-sm text-zinc-500">Adaptive learning across AWS, GCP, Python, SQL, AI, ML, MLOps, and Data Engineering — no API needed</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="btnExport" class="btn" title="Export progress as JSON"><i data-lucide="download"></i><span class="hidden sm:inline">Export</span></button>
        <button id="btnImport" class="btn" title="Import progress from JSON"><i data-lucide="upload"></i><span class="hidden sm:inline">Import</span></button>
        <input id="fileImport" type="file" accept="application/json" class="hidden"/>
      </div>
    </header>

    <div class="grid md:grid-cols-[260px_1fr] gap-4">
      <!-- Sidebar -->
      <aside class="card p-4">
        <div class="flex items-center justify-between mb-3">
          <h2 class="font-semibold">Topics</h2>
          <span class="chip">Streak: <span id="streakVal" aria-live="polite">0</span></span>
        </div>
        <div id="topicList" class="grid gap-2"></div>

        <div class="mt-6">
          <label class="text-sm font-medium">Difficulty</label>
          <div id="difficultyBadges" class="mt-2 flex gap-2">
            <span class="chip" data-level="Easy">Easy</span>
            <span class="chip" data-level="Medium">Medium</span>
            <span class="chip" data-level="Hard">Hard</span>
          </div>
        </div>

        <div class="mt-6 border-t border-zinc-200 dark:border-zinc-800 pt-4 grid gap-2">
          <button id="btnReportsTab" class="btn"><i data-lucide="bar-chart-3"></i>Reports</button>
          <button id="btnStudyPlan" class="btn"><i data-lucide="lightbulb"></i>Study Plan</button>
          <button id="btnReset" class="btn"><i data-lucide="refresh-ccw"></i>Reset Session</button>
          <button id="btnHardReset" class="btn"><i data-lucide="trash-2"></i>Factory Reset</button>
        </div>
      </aside>

      <!-- Main -->
      <main class="grid gap-4">
        <!-- Quiz -->
        <section class="card p-4">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <h2 class="text-lg font-semibold">Quiz</h2>
              <span id="currentTopicBadge" class="chip">Topic: —</span>
              <span id="currentLevelBadge" class="chip">Level: —</span>
            </div>
            <div class="text-sm text-zinc-500">Press <span class="kbd">1</span><span class="kbd">2</span><span class="kbd">3</span><span class="kbd">4</span></div>
          </div>
          <div class="mt-4">
            <div id="questionText" class="text-xl font-medium"></div>
            <ul id="choices" class="mt-4 grid gap-2"></ul>
          </div>
          <div class="mt-4 flex items-center justify-between">
            <div class="flex items-center gap-2">
              <button id="btnExplain" class="btn" disabled><i data-lucide="message-circle-question"></i>Explain</button>
              <button id="btnNext" class="btn btn-primary">Next Question</button>
            </div>
            <div class="text-sm text-zinc-500">Progress saved locally</div>
          </div>
          <div id="explanationBox" class="mt-4 hidden">
            <div class="rounded-xl border border-amber-300/50 bg-amber-50 dark:bg-amber-950/20 p-3">
              <div class="text-amber-700 dark:text-amber-300 font-semibold mb-1">Explanation</div>
              <div id="explanationText" class="text-sm leading-6"></div>
            </div>
          </div>
        </section>

        <!-- Reports -->
        <section class="card p-4">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold">Reports</h2>
            <div class="text-sm text-zinc-500">Performance by Topic × Difficulty</div>
          </div>
          <div class="grid md:grid-cols-2 gap-4 mt-3">
            <canvas id="chartTopic" height="220"></canvas>
            <canvas id="chartMatrix" height="220"></canvas>
          </div>
          <div class="mt-3">
            <table class="w-full text-sm">
              <thead class="text-zinc-500">
                <tr><th class="text-left py-2">Topic</th><th class="text-left">Easy</th><th class="text-left">Medium</th><th class="text-left">Hard</th><th class="text-left">Total</th></tr>
              </thead>
              <tbody id="reportTable"></tbody>
            </table>
          </div>
        </section>

        <!-- Study Plan (Offline) -->
        <section class="card p-4">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold">Personalized Study Plan (Offline)</h2>
            <button id="btnRefreshPlan" class="btn"><i data-lucide="rotate-ccw"></i>Refresh</button>
          </div>
          <div id="studyPlanBox" class="mt-3 text-sm leading-6 space-y-3">
            <p>Click “Study Plan” to generate a 1-week plan from your weakest areas using curated official resources. No API required.</p>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- Toasts -->
  <div id="toastHost" class="fixed top-4 right-4 space-y-2 z-50"></div>

  <!-- Optional compressed bank slot (overrides default BANK if present) -->
  <!-- <script type="application/json" id="bank-lz">BASE64_FROM_LZSTRING_HERE</script> -->

  <!-- Minimal LZ-String (decompress only) -->
  <script>
  const LZString=(function(){function o(o,r){if(!t[o]){t[o]={};for(var n=0;n<o.length;n++)t[o][o.charAt(n)]=n}return t[o][r]}var r=String.fromCharCode,n={};var t={};var e={decompressFromBase64:function(t){if(null==t)return"";if(""==t)return null;return e._decompress(t.length,32,function(e){return o("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",t.charAt(e))})},_decompress:function(o,t,e){var i,s,a,u,c,l,h,d,f=[],p=4,m=4,g=3,v="",w=[],A={val:e(0),position:t,index:1};for(i=0;i<3;i+=1)f[i]=i;u=0;c=Math.pow(2,2);l=1;while(l!=c){h=A.val&A.position;A.position>>=1;if(0==A.position){A.position=t;A.val=e(A.index++)}u|=(h>0?1:0)*l;l<<=1}switch(u){case 0:u=0;c=Math.pow(2,8);l=1;while(l!=c){h=A.val&A.position;A.position>>=1;if(0==A.position){A.position=t;A.val=e(A.index++)}u|=(h>0?1:0)*l;l<<=1}d=r(u);break;case 1:u=0;c=Math.pow(2,16);l=1;while(l!=c){h=A.val&A.position;A.position>>=1;if(0==A.position){A.position=t;A.val=e(A.index++)}u|=(h>0?1:0)*l;l<<=1}d=r(u);break;case 2:return""}f[3]=d;var b=d;w.push(d);while(true){if(A.index>o)return"";u=0;c=Math.pow(2,g);l=1;while(l!=c){h=A.val&A.position;A.position>>=1;if(0==A.position){A.position=t;A.val=e(A.index++)}u|=(h>0?1:0)*l;l<<=1}switch(s=u){case 0:u=0;c=Math.pow(2,8);l=1;while(l!=c){h=A.val&A.position;A.position>>=1;if(0==A.position){A.position=t;A.val=e(A.index++)}u|=(h>0?1:0)*l;l<<=1}f[m++]=r(u);s=m-1;break;case 1:u=0;c=Math.pow(2,16);l=1;while(l!=c){h=A.val&A.position;A.position>>=1;if(0==A.position){A.position=t;A.val=e(A.index++)}u|=(h>0?1:0)*l;l<<=1}f[m++]=r(u);s=m-1;break;case 2:return w.join("")}if(0==s)return"";if(s<f.length)d=f[s];else if(s===m)d=b+b.charAt(0);else return null;w.push(d);f[m++]=b+d.charAt(0);b=d;if(0==--p){p=Math.pow(2,g);g++}}}};return e})();
  </script>

  <script>
  // ==============================
  // Offline Quiz Engine (procedural)
  // ==============================
  const TOPICS = ["AWS","GCP","Python","SQL","AI","ML","MLOps","Data Engineering"];
  const LEVELS = ["Easy","Medium","Hard"];
  const PROMOTION_STREAK = 3;
  const MOTIVATION_STREAKS = [3,5,8,12];
  const STORAGE_KEY = "aiml_quiz_offline_proc_v1";

  // ---------- Default BANK (truncated here for brevity – same as previous message) ----------
  // (Full bank kept intentionally—omitted in this explanation to save space. Use the same BANK block
  //   from the last response; nothing else changed except wiring.)
  const BANK = {/* ... (same BANK content from the previous message) ... */};
  // --------------- end bank ---------------

  // ---------- Optional: load a compressed bank if provided ----------
  function tryLoadCompressedBank(){
    const node = document.getElementById("bank-lz");
    if (!node) return null;
    try {
      const raw = node.textContent.trim();
      if (!raw) return null;
      const json = LZString.decompressFromBase64(raw);
      return JSON.parse(json);
    } catch { return null; }
  }

  // Build per-topic/level items with IDs
  const bank = {};
  const SOURCE = tryLoadCompressedBank() || BANK;
  for (const t of TOPICS) {
    bank[t] = {};
    for (const L of LEVELS) {
      bank[t][L] = (SOURCE[t]?.[L] || []).map(([term,desc,meta],i)=>({
        id: `${t}-${L}-${i}`, topic:t, level:L, term, desc, meta: meta || {}
      }));
    }
  }

  // ---------- State ----------
  let state = {
    currentTopic: "AWS",
    currentLevel: "Easy",
    streaks: {},
    counters: {},
    history: [],
    recentIds: {}
  };

  // ---------- Utils ----------
  const $ = (s,r=document)=>r.querySelector(s);
  const $all = (s,r=document)=>[...r.querySelectorAll(s)];
  function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
  function loadState(){ const raw=localStorage.getItem(STORAGE_KEY); if (raw) try{ state=Object.assign(state,JSON.parse(raw)); }catch{} }
  function ensureTL(obj,t,l,init){ if(!obj[t]) obj[t]={}; if(!obj[t][l]) obj[t][l]=init; }
  function toast(html,variant="info",ms=2400){
    const host=$("#toastHost"); const d=document.createElement("div");
    d.className="card p-3 pop border-l-4 "+(variant==="success"?"border-l-green-500":variant==="warn"?"border-l-amber-500":"border-l-indigo-500");
    d.innerHTML=html; host.appendChild(d); setTimeout(()=>d.remove(),ms);
  }
  function rngPick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

  function getStreak(t,l){ ensureTL(state.streaks,t,l,0); return state.streaks[t][l]; }
  function setStreak(t,l,v){ ensureTL(state.streaks,t,l,0); state.streaks[t][l]=Math.max(0,v); }
  function incCounter(t,l,c){ ensureTL(state.counters,t,l,{correct:0,total:0}); state.counters[t][l].total++; if(c) state.counters[t][l].correct++; }
  function accuracy(t,l){ const c=state.counters[t]?.[l]||{correct:0,total:0}; return c.total?c.correct/c.total:0; }

  // ---------- Template helpers ----------
  function sampleK(arr, k, pred = () => true) {
    const pool = arr.filter(pred);
    const out = [];
    while (out.length < k && pool.length) {
      const i = Math.floor(Math.random()*pool.length);
      out.push(pool.splice(i,1)[0]);
    }
    return out;
  }
  function hasAllTags(item, tagset) {
    const t = (item.meta?.tags) || [];
    return tagset.every(x => t.includes(x));
  }
  function scenarioFromTags(term, tags) {
    const map = {
      storage: "store large amounts of data",
      object: "get object-based access",
      durable: "achieve extreme durability",
      http: "serve content over the web",
      serverless: "avoid managing servers",
      stream: "ingest real-time events",
      queue: "decouple components via queues",
      kubernetes: "orchestrate containers with Kubernetes",
      sql: "analyze with standard SQL",
      nosql: "scale with low-latency NoSQL",
      redis: "cache hot data in memory",
      warehouse: "analyze at warehouse scale"
    };
    const bits = tags.map(t => map[t]).filter(Boolean).slice(0,3);
    if (!bits.length) return `Which option best fits the described need?`;
    return `You need to ${bits.join(", ")}. Which option fits best?`;
  }

  // ---------- Procedural question builder ----------
  function makeQuestion(topic, level){
    const pool = bank[topic][level];
    if (!pool || pool.length===0) return null;

    // avoid immediate repeats
    const key = `${topic}|${level}`;
    const recent = state.recentIds[key] || [];
    const candidates = pool.filter(q => !recent.includes(q.id));
    const target = (candidates.length>0 ? rngPick(candidates) : rngPick(pool));

    const others = pool.filter(q => q.id !== target.id);
    const hasTags = !!(target.meta?.tags?.length);
    const styles = hasTags ? ["desc->term","term->desc","scenario","truefalse","not-true"] : ["desc->term","term->desc"];
    const style = rngPick(styles);

    let stem, choices, answerIndex, explanation;

    if (style === "desc->term") {
      const distract = sampleK(others, 3);
      stem = `(${topic} / ${level}) Which option best matches: "${target.desc}"?`;
      choices = shuffle([target.term, ...distract.map(d=>d.term)]);
      answerIndex = choices.indexOf(target.term);
      explanation = `Correct: ${target.term} — ${target.desc}`;
    }
    else if (style === "term->desc") {
      const distract = sampleK(others, 3);
      stem = `(${topic} / ${level}) What does "${target.term}" most closely mean?`;
      choices = shuffle([target.desc, ...distract.map(d=>d.desc)]);
      answerIndex = choices.indexOf(target.desc);
      explanation = `Correct: ${target.term} — ${target.desc}`;
    }
    else if (style === "scenario") {
      const tags = (target.meta?.tags || []).slice(0,3);
      const distract = sampleK(others, 3, d => !hasAllTags(d, tags));
      stem = `(${topic} / ${level}) ${scenarioFromTags(target.term, tags)}`;
      choices = shuffle([target.term, ...distract.map(d=>d.term)]);
      answerIndex = choices.indexOf(target.term);
      explanation = `Why ${target.term}? ${target.desc}`;
    }
    else if (style === "truefalse") {
      const good = `${target.term} — ${target.desc}`;
      const wrongs = sampleK(others, 3).map(d => `${d.term} — ${target.desc}`);
      stem = `(${topic} / ${level}) Which statement is TRUE?`;
      choices = shuffle([good, ...wrongs]);
      answerIndex = choices.indexOf(good);
      explanation = `Only "${target.term} — ${target.desc}" is accurate for this concept.`;
    }
    else { // "not-true"
      const good3 = sampleK(others, 3).map(d => `${d.term} — ${d.desc}`);
      const wrong = `${target.term} — ${rngPick(others).desc}`;
      stem = `(${topic} / ${level}) Which statement is NOT true?`;
      choices = shuffle([wrong, ...good3]);
      answerIndex = choices.indexOf(wrong);
      explanation = `The mismatched statement pairs ${target.term} with the wrong description.`;
    }

    // track recently asked
    recent.unshift(target.id); state.recentIds[key] = recent.slice(0,18);

    return { id: target.id + "|" + style, topic, level, stem, choices, answerIndex, explanation };
  }

  function shuffle(a){ const x=[...a]; for(let i=x.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [x[i],x[j]]=[x[j],x[i]]; } return x; }

  // ---------- UI ----------
  const charts = { topic: null, matrix: null }; // <-- fixed: avoid id collisions
  let currentQ = null;

  function renderTopics(){
    const host=$("#topicList"); host.innerHTML="";
    for (const t of TOPICS){
      const btn=document.createElement("button");
      btn.className="btn justify-between";
      const overall=(LEVELS.map(L=>accuracy(t,L)).reduce((a,b)=>a+b,0)/3*100)|0;
      btn.innerHTML=`<span>${t}</span><span class="chip">${overall}%</span>`;
      btn.onclick=()=>{ state.currentTopic=t; saveState(); updateContext(); nextQuestion(); };
      host.appendChild(btn);
    }
  }
  function updateContext(){
    $("#currentTopicBadge").textContent="Topic: "+state.currentTopic;
    $("#currentLevelBadge").textContent="Level: "+state.currentLevel;
    $("#streakVal").textContent=getStreak(state.currentTopic,state.currentLevel);
    $all("#difficultyBadges .chip").forEach(el=>{
      el.classList.toggle("bg-indigo-600/10", el.dataset.level===state.currentLevel);
      el.classList.toggle("border-indigo-600", el.dataset.level===state.currentLevel);
      el.onclick=()=>{ state.currentLevel=el.dataset.level; saveState(); updateContext(); nextQuestion(); };
    });
  }
  function renderQuestion(q){
    $("#questionText").textContent=q.stem;
    const ul=$("#choices"); ul.innerHTML="";
    q.choices.forEach((c,i)=>{
      const li=document.createElement("li");
      li.innerHTML=`<button class="w-full text-left btn" data-index="${i}">
        <span class="kbd mr-2">${i+1}</span>${c}
      </button>`;
      li.querySelector("button").onclick=()=>answer(i);
      ul.appendChild(li);
    });
    $("#explanationBox").classList.add("hidden");
    $("#btnExplain").disabled=true;
  }
  function nextQuestion(){
    const q=makeQuestion(state.currentTopic,state.currentLevel);
    if(!q){ $("#questionText").textContent="No questions available."; $("#choices").innerHTML=""; return; }
    currentQ=q; renderQuestion(q);
  }
  function answer(idx){
    if(!currentQ) return;
    const correct=(idx===currentQ.answerIndex);
    incCounter(currentQ.topic,currentQ.level,correct);
    if(correct){ setStreak(currentQ.topic,currentQ.level,getStreak(currentQ.topic,currentQ.level)+1); }
    else { setStreak(currentQ.topic,currentQ.level,0); }
    promoteOrDemote(currentQ.topic,currentQ.level,correct);

    // UI feedback
    $all("#choices button").forEach((b,i)=>{
      b.disabled=true;
      if(i===currentQ.answerIndex) b.classList.add("bg-green-600","text-white","border-green-600");
      if(i===idx && !correct) b.classList.add("bg-red-600","text-white","border-red-600");
    });

    // history + save + reports
    state.history.unshift({topic:currentQ.topic, level:currentQ.level, correct, qid:currentQ.id, ts:Date.now()});
    state.history=state.history.slice(0,500);
    saveState();
    refreshReports();
    renderTopics();              // <-- fixed: refresh sidebar %
    updateContext();             // <-- ensure streak shows latest

    // explanation
    $("#btnExplain").disabled=false;
    $("#explanationBox").classList.remove("hidden");
    $("#explanationText").textContent=currentQ.explanation;
  }
  function promoteOrDemote(topic, level, correct){
    const idx=LEVELS.indexOf(level);
    if(correct){
      const s=getStreak(topic,level);
      if(MOTIVATION_STREAKS.includes(s)){
        toast(`<div class="font-semibold">Nice streak</div><div class="text-sm">You hit ${s} in ${topic} (${level}).</div>`,"success");
      }
      if(s>=PROMOTION_STREAK && idx<LEVELS.length-1){
        state.currentLevel=LEVELS[idx+1];
        toast(`<div class="font-semibold">Promoted to ${state.currentLevel}</div><div class="text-sm">Harder questions unlocked in ${topic}.</div>`,"success");
        setStreak(topic,state.currentLevel,0);
      }
    } else {
      if(idx>0){
        state.currentLevel=LEVELS[idx-1];
        toast(`<div class="font-semibold">Demoted to ${state.currentLevel}</div><div class="text-sm">Reinforce ${topic} fundamentals and climb back.</div>`,"warn");
      }
    }
  }

  // ---------- Reports ----------
  function refreshReports(){
    const topicAcc=TOPICS.map(t=>{
      const total=LEVELS.reduce((s,L)=>s+((state.counters[t]?.[L]?.total)||0),0);
      const correct=LEVELS.reduce((s,L)=>s+((state.counters[t]?.[L]?.correct)||0),0);
      return total?(correct/total*100):0;
    });

    // Table
    const tbody=$("#reportTable"); tbody.innerHTML="";
    for(const t of TOPICS){
      const row=document.createElement("tr");
      row.className="border-t border-zinc-200 dark:border-zinc-800";
      const cells=[t]
        .concat(LEVELS.map(L=>{
          const c=state.counters[t]?.[L]||{correct:0,total:0};
          const pct=c.total?Math.round(c.correct/c.total*100):0;
          return `${pct}% (${c.correct}/${c.total})`;
        }))
        .concat((()=>{
          const total=LEVELS.reduce((s,L)=>s+((state.counters[t]?.[L]?.total)||0),0);
          const correct=LEVELS.reduce((s,L)=>s+((state.counters[t]?.[L]?.correct)||0),0);
          return total?`${Math.round(correct/total*100)}% (${correct}/${total})`:"0% (0/0)";
        })());
      row.innerHTML=cells.map((c,i)=>`<td class="py-2 ${i===0?"font-medium":""}">${c}</td>`).join("");
      tbody.appendChild(row);
    }

    // Charts (use dedicated vars; don't collide with element IDs)
    const canvasTopic=document.getElementById("chartTopic");
    if (charts.topic && typeof charts.topic.destroy==="function") charts.topic.destroy();
    charts.topic=new Chart(canvasTopic,{type:"bar",data:{labels:TOPICS,datasets:[{label:"Accuracy %",data:topicAcc}]},options:{responsive:true,scales:{y:{suggestedMin:0,suggestedMax:100}}}});

    const levelSets=LEVELS.map(L=>({label:L,data:TOPICS.map(t=>{const c=state.counters[t]?.[L]||{correct:0,total:0};return c.total?Math.round(c.correct/c.total*100):0;}),stack:"levels"}));
    const canvasMatrix=document.getElementById("chartMatrix");
    if (charts.matrix && typeof charts.matrix.destroy==="function") charts.matrix.destroy();
    charts.matrix=new Chart(canvasMatrix,{type:"bar",data:{labels:TOPICS,datasets:levelSets},options:{responsive:true,scales:{y:{suggestedMin:0,suggestedMax:100},x:{stacked:true},yAxes:{stacked:true}}}});
  }

  // ---------- Offline Study Plan ----------
  const LINKS = {
    AWS:["https://docs.aws.amazon.com","https://aws.amazon.com/architecture/","https://catalog.workshops.aws/"],
    GCP:["https://cloud.google.com/docs","https://cloud.google.com/architecture","https://cloudskillsboost.google/"],
    Python:["https://docs.python.org/3/","https://realpython.com/","https://docs.python.org/3/library/index.html"],
    SQL:["https://www.postgresql.org/docs/","https://dev.mysql.com/doc/","https://www.sqlite.org/docs.html"],
    AI:["https://scikit-learn.org/stable/","https://developers.google.com/machine-learning/crash-course","https://pytorch.org/tutorials/"],
    ML:["https://scikit-learn.org/stable/user_guide.html","https://xgboost.readthedocs.io/","https://lightgbm.readthedocs.io/"],
    MLOps:["https://ml-ops.org/","https://docs.dagster.io/","https://airflow.apache.org/docs/"],
    "Data Engineering":["https://spark.apache.org/docs/latest/","https://delta.io/","https://kafka.apache.org/documentation/"]
  };
  function offlinePlan(){
    const recent=state.history.slice(0,80);
    const score={};
    for(const h of recent){
      const k=`${h.topic}|${h.level}`;
      if(!score[k]) score[k]={correct:0,total:0,topic:h.topic,level:h.level};
      score[k].total++; if(h.correct) score[k].correct++;
    }
    const entries=Object.values(score).map(x=>({...x,acc:x.total?x.correct/x.total:0}));
    entries.sort((a,b)=>a.acc-b.acc);
    const weak=entries.slice(0,3);
    const lines=weak.length?weak.map(w=>`- ${w.topic} @ ${w.level}: ${(w.acc*100|0)}% (${w.correct}/${w.total})`):["- Not enough data yet (answer some questions)."];
    let html=`<h3 class='text-base font-semibold'>Your 7-Day Plan</h3><p class='text-sm text-zinc-500'>Generated locally from your weakest areas.</p>`;
    html+=`<p class='mt-2'><span class='font-semibold'>Focus:</span></p><ul class='list-disc ml-6'>${lines.map(x=>`<li>${x}</li>`).join("")}</ul>`;
    html+=`<p class='mt-3'>Daily (30–45 min):</p><ul class='list-disc ml-6'>
      <li>10 min: Review notes/flashcards for the weak topic & difficulty.</li>
      <li>15–20 min: Answer 15–25 questions in this app at the current level.</li>
      <li>10–15 min: Read one official resource.</li>
    </ul>`;
    if(weak.length){
      const tset=[...new Set(weak.map(w=>w.topic))];
      html+=`<p class='mt-3 font-semibold'>Resources:</p>`;
      html+=tset.map(t=>{const L=(LINKS[t]||[]).map(u=>`<a class="link" target="_blank" rel="noopener">${u}</a>`).join(" • "); return `<p><span class='font-medium'>${t}:</span> ${L}</p>`;}).join("");
    } else {
      html+=`<p class='mt-3'>Start with any topic’s Easy level. Suggested links: ${LINKS.Python.map(u=>`<a class="link" target="_blank" rel="noopener">${u}</a>`).join(" • ")}</p>`;
    }
    $("#studyPlanBox").innerHTML=html;
  }

  // ---------- Export / Import (progress only) ----------
  function download(filename, text){
    const a=document.createElement("a");
    a.href=URL.createObjectURL(new Blob([text],{type:"application/json"}));
    a.download=filename; a.click(); URL.revokeObjectURL(a.href);
  }
  $("#btnExport").onclick=()=>{ download("quiz-progress.json", JSON.stringify(state,null,2)); toast("Progress exported as JSON.","success"); };
  $("#btnImport").onclick=()=>$("#fileImport").click();
  $("#fileImport").addEventListener("change", async (e)=>{
    const f=e.target.files[0]; if(!f) return;
    try{ const txt=await f.text(); const payload=JSON.parse(txt); state=Object.assign(state,payload); saveState(); bootstrap(); toast("Progress imported.","success"); }
    catch{ toast("Invalid JSON file.","warn"); }
    e.target.value="";
  });

  // ---------- Events ----------
  $("#btnNext").onclick=nextQuestion;
  $("#btnExplain").onclick=()=>{ if(currentQ){ $("#explanationBox").classList.remove("hidden"); $("#explanationText").textContent=currentQ.explanation; } };
  $("#btnReportsTab").onclick=()=>{ refreshReports(); window.scrollTo({top:document.body.scrollHeight, behavior:"smooth"}); };
  $("#btnReset").onclick=()=>{ state.streaks={}; state.history=[]; saveState(); renderTopics(); updateContext(); toast("Session streaks cleared.","info"); };
  $("#btnHardReset").onclick=()=>{ localStorage.removeItem(STORAGE_KEY); location.reload(); };
  $("#btnStudyPlan").onclick=()=>{ offlinePlan(); window.scrollTo({top:document.body.scrollHeight, behavior:"smooth"}); };
  $("#btnRefreshPlan").onclick=()=> offlinePlan();
  document.addEventListener("keydown",(e)=>{
    if(["1","2","3","4"].includes(e.key)){
      const idx=Number(e.key)-1; const btn=document.querySelector(`#choices button[data-index="${idx}"]`); if(btn && !btn.disabled) btn.click();
    }
  });

  // ---------- Bootstrap ----------
  function bootstrap(){
    if(window.lucide?.createIcons) window.lucide.createIcons();
    renderTopics(); updateContext(); refreshReports(); nextQuestion();
  }
  loadState(); bootstrap();
  </script>
</body>
</html>
