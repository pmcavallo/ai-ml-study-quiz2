<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>AI/ML Quiz — Offline (Procedural)</title>

  <!-- UI libs (no backends) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@0.468.0/dist/umd/lucide.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root { color-scheme: light dark; }
    .card { @apply bg-white/80 dark:bg-zinc-900/70 backdrop-blur rounded-2xl shadow-lg border border-zinc-200/60 dark:border-zinc-800; }
    .btn { @apply inline-flex items-center gap-2 rounded-xl px-4 py-2 font-medium border border-zinc-300 dark:border-zinc-700 hover:bg-zinc-50 dark:hover:bg-zinc-800; }
    .btn-primary { @apply bg-indigo-600 text-white border-indigo-600 hover:bg-indigo-500; }
    .chip { @apply text-xs px-2 py-0.5 rounded-full border border-zinc-300 dark:border-zinc-700; }
    .kbd { @apply inline-block rounded-lg border border-zinc-300 dark:border-zinc-700 px-1.5 py-0.5 text-xs font-mono; }
    .pop { animation: pop .22s ease-out both; }
    @keyframes pop { from { transform: scale(.97); opacity:0; } to { transform: scale(1); opacity:1; } }
    a.link { @apply text-indigo-600 underline; }
  </style>
</head>
<body class="bg-gradient-to-br from-zinc-50 to-white dark:from-zinc-950 dark:to-zinc-900 text-zinc-900 dark:text-zinc-100 min-h-screen">
  <div class="max-w-6xl mx-auto px-4 py-6">
    <!-- Header -->
    <header class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-2xl bg-indigo-600 grid place-content-center text-white font-bold">AI</div>
        <div>
          <h1 class="text-2xl font-semibold">AI/ML Quiz — Offline (Procedural)</h1>
          <p class="text-sm text-zinc-500">Adaptive learning across AWS, GCP, Python, SQL, AI, ML, MLOps, and Data Engineering — no API needed</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="btnExport" class="btn" title="Export progress as JSON"><i data-lucide="download"></i><span class="hidden sm:inline">Export</span></button>
        <button id="btnImport" class="btn" title="Import progress from JSON"><i data-lucide="upload"></i><span class="hidden sm:inline">Import</span></button>
        <input id="fileImport" type="file" accept="application/json" class="hidden"/>
      </div>
    </header>

    <div class="grid md:grid-cols-[260px_1fr] gap-4">
      <!-- Sidebar -->
      <aside class="card p-4">
        <div class="flex items-center justify-between mb-3">
          <h2 class="font-semibold">Topics</h2>
          <span class="chip">Streak: <span id="streakVal">0</span></span>
        </div>
        <div id="topicList" class="grid gap-2"></div>

        <div class="mt-6">
          <label class="text-sm font-medium">Difficulty</label>
          <div id="difficultyBadges" class="mt-2 flex gap-2">
            <span class="chip" data-level="Easy">Easy</span>
            <span class="chip" data-level="Medium">Medium</span>
            <span class="chip" data-level="Hard">Hard</span>
          </div>
        </div>

        <div class="mt-6 border-t border-zinc-200 dark:border-zinc-800 pt-4 grid gap-2">
          <button id="btnReportsTab" class="btn"><i data-lucide="bar-chart-3"></i>Reports</button>
          <button id="btnStudyPlan" class="btn"><i data-lucide="lightbulb"></i>Study Plan</button>
          <button id="btnReset" class="btn"><i data-lucide="refresh-ccw"></i>Reset Session</button>
          <button id="btnHardReset" class="btn"><i data-lucide="trash-2"></i>Factory Reset</button>
        </div>
      </aside>

      <!-- Main -->
      <main class="grid gap-4">
        <!-- Quiz -->
        <section class="card p-4">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <h2 class="text-lg font-semibold">Quiz</h2>
              <span id="currentTopicBadge" class="chip">Topic: —</span>
              <span id="currentLevelBadge" class="chip">Level: —</span>
            </div>
            <div class="text-sm text-zinc-500">Press <span class="kbd">1</span><span class="kbd">2</span><span class="kbd">3</span><span class="kbd">4</span></div>
          </div>
          <div class="mt-4">
            <div id="questionText" class="text-xl font-medium"></div>
            <ul id="choices" class="mt-4 grid gap-2"></ul>
          </div>
          <div class="mt-4 flex items-center justify-between">
            <div class="flex items-center gap-2">
              <button id="btnExplain" class="btn" disabled><i data-lucide="message-circle-question"></i>Explain</button>
              <button id="btnNext" class="btn btn-primary">Next Question</button>
            </div>
            <div class="text-sm text-zinc-500">Progress saved locally</div>
          </div>
          <div id="explanationBox" class="mt-4 hidden">
            <div class="rounded-xl border border-amber-300/50 bg-amber-50 dark:bg-amber-950/20 p-3">
              <div class="text-amber-700 dark:text-amber-300 font-semibold mb-1">Explanation</div>
              <div id="explanationText" class="text-sm leading-6"></div>
            </div>
          </div>
        </section>

        <!-- Reports -->
        <section class="card p-4">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold">Reports</h2>
            <div class="text-sm text-zinc-500">Performance by Topic × Difficulty</div>
          </div>
          <div class="grid md:grid-cols-2 gap-4 mt-3">
            <canvas id="chartTopic" height="220"></canvas>
            <canvas id="chartMatrix" height="220"></canvas>
          </div>
          <div class="mt-3">
            <table class="w-full text-sm">
              <thead class="text-zinc-500">
                <tr><th class="text-left py-2">Topic</th><th class="text-left">Easy</th><th class="text-left">Medium</th><th class="text-left">Hard</th><th class="text-left">Total</th></tr>
              </thead>
              <tbody id="reportTable"></tbody>
            </table>
          </div>
        </section>

        <!-- Study Plan (Offline) -->
        <section class="card p-4">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold">Personalized Study Plan (Offline)</h2>
            <button id="btnRefreshPlan" class="btn"><i data-lucide="rotate-ccw"></i>Refresh</button>
          </div>
          <div id="studyPlanBox" class="mt-3 text-sm leading-6 space-y-3">
            <p>Click “Study Plan” to generate a 1-week plan from your weakest areas using curated official resources. No API required.</p>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- Toasts -->
  <div id="toastHost" class="fixed top-4 right-4 space-y-2 z-50"></div>

  <!-- Optional: Compressed bank slot. If present, it overrides the default BANK below.
       Paste a base64 string produced by LZString.compressToBase64(JSON.stringify(bankJson)):
       <script type="application/json" id="bank-lz">BASE64_HERE</script>
  -->

  <script>
  // --- Minimal LZ-String (decompressFromBase64 only) ---
  // Source: https://github.com/pieroxy/lz-string (MIT), trimmed for single function use.
  const LZString=(function(){function o(o,r){if(!t[o]){t[o]={};for(var n=0;n<o.length;n++)t[o][o.charAt(n)]=n}return t[o][r]}var r=String.fromCharCode,n={};var t={};var e={decompressFromBase64:function(t){if(null==t)return"";if(""==t)return null;return e._decompress(t.length,32,function(e){return o("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",t.charAt(e))})},_decompress:function(o,t,e){var i,s,a,u,c,l,h,d,f=[],p=4,m=4,g=3,v="",w=[],A={val:e(0),position:t,index:1};for(i=0;i<3;i+=1)f[i]=i;u=0;c=Math.pow(2,2);l=1;while(l!=c){h=A.val&A.position;A.position>>=1;if(0==A.position){A.position=t;A.val=e(A.index++)}u|=(h>0?1:0)*l;l<<=1}switch(u){case 0:u=0;c=Math.pow(2,8);l=1;while(l!=c){h=A.val&A.position;A.position>>=1;if(0==A.position){A.position=t;A.val=e(A.index++)}u|=(h>0?1:0)*l;l<<=1}d=r(u);break;case 1:u=0;c=Math.pow(2,16);l=1;while(l!=c){h=A.val&A.position;A.position>>=1;if(0==A.position){A.position=t;A.val=e(A.index++)}u|=(h>0?1:0)*l;l<<=1}d=r(u);break;case 2:return""}f[3]=d;var b=d;w.push(d);while(true){if(A.index>o)return"";u=0;c=Math.pow(2,g);l=1;while(l!=c){h=A.val&A.position;A.position>>=1;if(0==A.position){A.position=t;A.val=e(A.index++)}u|=(h>0?1:0)*l;l<<=1}switch(s=u){case 0:u=0;c=Math.pow(2,8);l=1;while(l!=c){h=A.val&A.position;A.position>>=1;if(0==A.position){A.position=t;A.val=e(A.index++)}u|=(h>0?1:0)*l;l<<=1}f[m++]=r(u);s=m-1;break;case 1:u=0;c=Math.pow(2,16);l=1;while(l!=c){h=A.val&A.position;A.position>>=1;if(0==A.position){A.position=t;A.val=e(A.index++)}u|=(h>0?1:0)*l;l<<=1}f[m++]=r(u);s=m-1;break;case 2:return w.join("")}if(0==s)return"";if(s<f.length)d=f[s];else if(s===m)d=b+b.charAt(0);else return null;w.push(d);f[m++]=b+d.charAt(0);b=d;if(0==--p){p=Math.pow(2,g);g++}}}};return e})();  
  </script>

  <script>
  // ==============================
  // Offline Quiz Engine (procedural)
  // ==============================
  const TOPICS = ["AWS","GCP","Python","SQL","AI","ML","MLOps","Data Engineering"];
  const LEVELS = ["Easy","Medium","Hard"];
  const PROMOTION_STREAK = 3;
  const MOTIVATION_STREAKS = [3,5,8,12];
  const STORAGE_KEY = "aiml_quiz_offline_proc_v1";

  // ---------- Default BANK (10 per difficulty with tags for richer templates) ----------
  // Format: [term, description, {tags:[...]}]
  const BANK = {
    "AWS": {
      Easy: [
        ["Amazon S3","Object storage for any amount of data; buckets, durable and scalable.",{tags:["aws","storage","object","durable","http","serverless"]}],
        ["Amazon EC2","Resizable virtual compute instances in the cloud.",{tags:["aws","compute","vm"]}],
        ["AWS Lambda","Run code without managing servers; event-driven functions.",{tags:["aws","serverless","compute","events"]}],
        ["Amazon RDS","Managed relational databases (MySQL, PostgreSQL, etc.).",{tags:["aws","database","sql","managed"]}],
        ["Amazon CloudFront","Global CDN to cache and accelerate content.",{tags:["aws","cdn","edge","http"]}],
        ["AWS IAM","Identity and access management for users, roles, and policies.",{tags:["aws","security","iam"]}],
        ["Amazon VPC","Isolated virtual network for your AWS resources.",{tags:["aws","network","vpc"]}],
        ["Amazon Route 53","Scalable DNS and domain registration service.",{tags:["aws","dns","network"]}],
        ["Elastic Beanstalk","PaaS to deploy web apps without managing servers.",{tags:["aws","paas","deploy"]}],
        ["Amazon EBS","Block storage volumes for EC2 instances.",{tags:["aws","block","storage"]}]
      ],
      Medium: [
        ["Amazon DynamoDB","Managed NoSQL key-value and document database with millisecond latency.",{tags:["aws","database","nosql","serverless"]}],
        ["Amazon SQS","Fully managed message queues for decoupling components.",{tags:["aws","queue","async"]}],
        ["Amazon SNS","Pub/Sub notifications to topics, SMS, email, HTTP.",{tags:["aws","pubsub","events"]}],
        ["Amazon Kinesis","Real-time data streaming ingestion and analytics.",{tags:["aws","stream","realtime"]}],
        ["Amazon CloudWatch","Metrics, logs, and alarms for monitoring.",{tags:["aws","monitoring","logs","metrics"]}],
        ["Amazon ECS","Container orchestration on EC2 or Fargate.",{tags:["aws","containers","orchestration"]}],
        ["Amazon EKS","Managed Kubernetes control plane for containers.",{tags:["aws","kubernetes","containers"]}],
        ["Amazon ElastiCache","Managed Redis/Memcached for low-latency caching.",{tags:["aws","cache","redis"]}],
        ["AWS Fargate","Serverless compute for containers.",{tags:["aws","containers","serverless"]}],
        ["Amazon API Gateway","Managed API endpoints and throttling/keys.",{tags:["aws","api","gateway"]}]
      ],
      Hard: [
        ["AWS Step Functions","Serverless orchestration with state machines, retries, and timeouts.",{tags:["aws","orchestration","serverless"]}],
        ["AWS Glue","Serverless data integration/ETL with Data Catalog.",{tags:["aws","etl","data","serverless"]}],
        ["Amazon Athena","Serverless interactive SQL over S3 using Trino/Presto.",{tags:["aws","sql","s3","serverless"]}],
        ["Amazon Redshift","MPP cloud data warehouse at petabyte scale.",{tags:["aws","warehouse","sql","analytics"]}],
        ["Amazon SageMaker","Build/train/deploy ML models at scale on AWS.",{tags:["aws","ml","platform"]}],
        ["Amazon EMR","Managed Hadoop/Spark for big data processing.",{tags:["aws","spark","hadoop","big-data"]}],
        ["Amazon MWAA","Managed Apache Airflow for pipelines.",{tags:["aws","orchestration","airflow"]}],
        ["AWS Lake Formation","Centralized permissions & governance for lakes on S3.",{tags:["aws","governance","security","lake"]}],
        ["Amazon OpenSearch Service","Managed OpenSearch/Elasticsearch for search/analytics.",{tags:["aws","search","analytics"]}],
        ["Amazon Bedrock","Access to foundation models and orchestration for genAI.",{tags:["aws","genai","foundation-models"]}]
      ]
    },
    "GCP": {
      Easy: [
        ["Cloud Storage","Durable object storage; buckets and multi-regional classes.",{tags:["gcp","storage","object","durable"]}],
        ["Compute Engine","Virtual machine instances on Google Cloud.",{tags:["gcp","compute","vm"]}],
        ["Cloud Functions","Serverless functions triggered by events or HTTP.",{tags:["gcp","serverless","compute","events"]}],
        ["Cloud SQL","Managed relational databases (MySQL, Postgres, SQL Server).",{tags:["gcp","database","sql","managed"]}],
        ["Cloud CDN","Global content delivery network on Google’s edge.",{tags:["gcp","cdn","edge","http"]}],
        ["IAM","Access control with roles, policies, service accounts.",{tags:["gcp","security","iam"]}],
        ["VPC","Isolated virtual network for GCP resources.",{tags:["gcp","network","vpc"]}],
        ["Cloud DNS","Scalable DNS service with managed zones.",{tags:["gcp","dns","network"]}],
        ["Persistent Disk","Block storage for VM instances.",{tags:["gcp","block","storage"]}],
        ["App Engine","PaaS for web apps with automatic scaling.",{tags:["gcp","paas","deploy"]}]
      ],
      Medium: [
        ["GKE","Managed Kubernetes for containers.",{tags:["gcp","kubernetes","containers"]}],
        ["Pub/Sub","Global messaging for event ingestion/delivery.",{tags:["gcp","pubsub","events"]}],
        ["Dataflow","Serverless Apache Beam for batch/stream.",{tags:["gcp","stream","batch","etl"]}],
        ["Cloud Run","Serverless containers from any language.",{tags:["gcp","containers","serverless"]}],
        ["Bigtable","Low-latency wide-column NoSQL.",{tags:["gcp","database","nosql"]}],
        ["Cloud Monitoring","Metrics/alerts/logs for workloads.",{tags:["gcp","monitoring","logs"]}],
        ["Memorystore","Managed Redis/Memcached.",{tags:["gcp","cache","redis"]}],
        ["Firestore","NoSQL document database.",{tags:["gcp","database","nosql","document"]}],
        ["Filestore","Managed NFS for file sharing.",{tags:["gcp","storage","file"]}],
        ["VPC Service Controls","Perimeter security to reduce data exfiltration risk.",{tags:["gcp","security","perimeter"]}]
      ],
      Hard: [
        ["BigQuery","Serverless analytics warehouse with SQL.",{tags:["gcp","warehouse","sql","analytics"]}],
        ["Composer","Managed Apache Airflow for pipelines.",{tags:["gcp","orchestration","airflow"]}],
        ["Dataproc","Managed Spark/Hadoop clusters.",{tags:["gcp","spark","hadoop","big-data"]}],
        ["Vertex AI","Unified ML platform for training/serving.",{tags:["gcp","ml","platform"]}],
        ["Datastream","Serverless CDC replication.",{tags:["gcp","cdc","replication"]}],
        ["AlloyDB","Postgres-compatible high-performance managed DB.",{tags:["gcp","database","sql"]}],
        ["Cloud Spanner","Horizontally scalable, strongly consistent relational DB.",{tags:["gcp","database","sql","global"]}],
        ["Looker","BI platform for modeling/visualization.",{tags:["gcp","bi","analytics"]}],
        ["Dataform","Versioned SQL pipelines and transforms.",{tags:["gcp","sql","pipelines"]}],
        ["Serverless Spark","Spark jobs on serverless infra.",{tags:["gcp","spark","serverless"]}]
      ]
    },
    "Python": {
      Easy: [
        ["list","Ordered, mutable sequence; [] syntax.",{tags:["python","data-structure"]}],
        ["dict","Key-value mapping; {} with unique keys.",{tags:["python","data-structure"]}],
        ["tuple","Ordered, immutable sequence; () syntax.",{tags:["python","data-structure"]}],
        ["set","Unordered collection of unique items.",{tags:["python","data-structure"]}],
        ["list comprehension","Build lists with [expr for x in it].",{tags:["python","syntax"]}],
        ["slicing","Retrieve subsequences with a[b:c:d].",{tags:["python","syntax"]}],
        ["venv","Create isolated Python environments.",{tags:["python","env"]}],
        ["pip","Package installer and dependency resolver.",{tags:["python","packages"]}],
        ["module","A file with Python code that can be imported.",{tags:["python","module"]}],
        ["f-string","String interpolation with f\"{expr}\".",{tags:["python","strings"]}]
      ],
      Medium: [
        ["generator","Yield values lazily; memory-efficient.",{tags:["python","iterators"]}],
        ["decorator","Wrapper that modifies function behavior.",{tags:["python","functions"]}],
        ["context manager","__enter__/__exit__ protocol via with.",{tags:["python","resources"]}],
        ["itertools","Efficient iteration utilities.",{tags:["python","iterators"]}],
        ["functools.lru_cache","Memoize pure functions.",{tags:["python","perf"]}],
        ["dataclasses","Boilerplate-free classes with auto methods.",{tags:["python","oop"]}],
        ["typing","Static type hints.",{tags:["python","types"]}],
        ["pytest","Testing framework with fixtures.",{tags:["python","tests"]}],
        ["pathlib","OO filesystem paths.",{tags:["python","files"]}],
        ["logging","Configurable logging library.",{tags:["python","diagnostics"]}]
      ],
      Hard: [
        ["GIL","Only one thread executes Python bytecode at a time.",{tags:["python","threads"]}],
        ["asyncio event loop","Runs coroutines/tasks for async IO.",{tags:["python","async"]}],
        ["multiprocessing","Bypass GIL via processes and IPC.",{tags:["python","parallel"]}],
        ["descriptors","Control attribute access via __get__/__set__.",{tags:["python","oop"]}],
        ["type hints & mypy","Static analysis to catch type errors.",{tags:["python","types"]}],
        ["metaclass","Customize class creation.",{tags:["python","oop"]}],
        ["CPython C-API","Build native extensions.",{tags:["python","c"]}],
        ["Cython","Compilation/type hints to speed Python.",{tags:["python","c","perf"]}],
        ["PyPy JIT","Alt interpreter with JIT.",{tags:["python","jit"]}],
        ["Protocols","Structural subtyping for flexible interfaces.",{tags:["python","types"]}]
      ]
    },
    "SQL": {
      Easy: [
        ["SELECT","Retrieve columns from tables or views.",{tags:["sql","query"]}],
        ["WHERE","Filter rows before grouping.",{tags:["sql","filter"]}],
        ["GROUP BY","Aggregate rows by column(s).",{tags:["sql","aggregate"]}],
        ["ORDER BY","Sort results ascending/descending.",{tags:["sql","sort"]}],
        ["JOIN","Combine rows across tables using keys.",{tags:["sql","join"]}],
        ["PRIMARY KEY","Uniquely identifies each row; non-null.",{tags:["sql","constraints"]}],
        ["FOREIGN KEY","References a primary key in another table.",{tags:["sql","constraints"]}],
        ["UNIQUE","Ensures all values are distinct.",{tags:["sql","constraints"]}],
        ["NULL vs NOT NULL","Missing/unknown vs required.",{tags:["sql","null"]}],
        ["INSERT/UPDATE/DELETE","Write operations to change rows.",{tags:["sql","dml"]}]
      ],
      Medium: [
        ["LEFT JOIN","All left rows; NULLs when no right match.",{tags:["sql","join"]}],
        ["INNER JOIN","Only rows with matches in both tables.",{tags:["sql","join"]}],
        ["HAVING","Filter after aggregation.",{tags:["sql","aggregate"]}],
        ["WINDOW FUNCTION","OVER() across partitions.",{tags:["sql","analytics"]}],
        ["CTE (WITH)","Name a subquery for reuse.",{tags:["sql","cte"]}],
        ["INDEX (B-tree)","Accelerates lookups/sorts.",{tags:["sql","index"]}],
        ["UNION vs UNION ALL","Distinct combine vs allow duplicates.",{tags:["sql","set"]}],
        ["COALESCE","Return first non-NULL expression.",{tags:["sql","null"]}],
        ["CASE WHEN","Conditional expressions in queries.",{tags:["sql","condition"]}],
        ["EXPLAIN","Show the optimizer’s execution plan.",{tags:["sql","explain"]}]
      ],
      Hard: [
        ["PARTITIONING","Split large tables by key/range.",{tags:["sql","scale"]}],
        ["ACID","Atomicity, Consistency, Isolation, Durability.",{tags:["sql","transactions"]}],
        ["ISOLATION LEVELS","Read committed, serializable, etc.",{tags:["sql","transactions"]}],
        ["QUERY PLAN","Strategy chosen by optimizer.",{tags:["sql","explain"]}],
        ["MATERIALIZED VIEW","Stored query result; refreshable.",{tags:["sql","materialized"]}],
        ["MVCC","Readers/writers with multi-version control.",{tags:["sql","concurrency"]}],
        ["Locking","Row/table locks coordinate updates.",{tags:["sql","concurrency"]}],
        ["Optimizer statistics","Stats guide cost-based choices.",{tags:["sql","optimizer"]}],
        ["Columnar storage","Column-oriented layouts for scans.",{tags:["sql","analytics"]}],
        ["Sharding","Horizontally split data across nodes.",{tags:["sql","scale"]}]
      ]
    },
    "AI": {
      Easy: [
        ["Supervised learning","Train on labeled input–output pairs.",{tags:["ai","supervised"]}],
        ["Unsupervised learning","Discover structure without labels.",{tags:["ai","unsupervised"]}],
        ["Overfitting","Model memorizes noise; poor generalization.",{tags:["ai","generalization"]}],
        ["Train/Val/Test split","Data partitions for fit/tune/check.",{tags:["ai","evaluation"]}],
        ["Precision vs Recall","Positive prediction quality vs coverage.",{tags:["ai","metrics"]}],
        ["k-fold CV","Rotate validation folds.",{tags:["ai","evaluation"]}],
        ["Confusion matrix","TP/FP/FN/TN table.",{tags:["ai","metrics"]}],
        ["Baseline model","Simple benchmark to beat.",{tags:["ai","metrics"]}],
        ["One-hot encoding","Binary indicators for categories.",{tags:["ai","features"]}],
        ["Normalization vs Standardization","[0,1] vs zero-mean/unit-variance.",{tags:["ai","prep"]}]
      ],
      Medium: [
        ["Regularization (L1/L2)","Penalize weights to reduce variance.",{tags:["ai","regularization"]}],
        ["ROC AUC","Ranking quality of positives.",{tags:["ai","metrics"]}],
        ["Calibration","Predicted probs match frequencies.",{tags:["ai","metrics"]}],
        ["Bias–Variance trade-off","Balance under/overfitting.",{tags:["ai","generalization"]}],
        ["Feature leakage","Target leaks into features.",{tags:["ai","pitfall"]}],
        ["F1 score","Harmonic mean of precision & recall.",{tags:["ai","metrics"]}],
        ["Early stopping","Stop when validation stalls.",{tags:["ai","regularization"]}],
        ["Hyperparameter tuning","Grid/random/Bayesian search.",{tags:["ai","tuning"]}],
        ["Cross-entropy loss","Log loss for classifiers.",{tags:["ai","loss"]}],
        ["Data augmentation","Synthetic variety to generalize.",{tags:["ai","prep"]}]
      ],
      Hard: [
        ["Attention mechanism","Weights context tokens during sequence modeling.",{tags:["ai","nlp","attention"]}],
        ["Transformers","Self-attention blocks replacing recurrence.",{tags:["ai","nlp","transformer"]}],
        ["Vector embeddings","Dense representations of meaning.",{tags:["ai","embeddings"]}],
        ["Reinforcement learning","Learn policies via rewards.",{tags:["ai","rl"]}],
        ["Causal inference","Estimate treatment effects.",{tags:["ai","causal"]}],
        ["Self-supervised learning","Learn representations without labels.",{tags:["ai","ssl"]}],
        ["Contrastive learning","Pull positives, push negatives.",{tags:["ai","ssl"]}],
        ["Diffusion models","Generative denoising processes.",{tags:["ai","genai"]}],
        ["LoRA fine-tuning","Low-rank adapters to adapt LLMs.",{tags:["ai","llm"]}],
        ["Knowledge distillation","Transfer teacher → student.",{tags:["ai","compression"]}]
      ]
    },
    "ML": {
      Easy: [
        ["Logistic regression","Linear classifier modeling log-odds.",{tags:["ml","classification","linear"]}],
        ["k-NN","Instance-based classification.",{tags:["ml","classification"]}],
        ["Decision tree","Greedy feature splits forming rules.",{tags:["ml","tree"]}],
        ["Naive Bayes","Probabilistic classifier assuming independence.",{tags:["ml","bayes"]}],
        ["Linear regression","Predict continuous target.",{tags:["ml","regression"]}],
        ["Feature scaling","Normalize/standardize features.",{tags:["ml","prep"]}],
        ["Train/validation/test split","Separate sets for fit/tune/final.",{tags:["ml","evaluation"]}],
        ["PCA (basics)","Lower-dimensional orthogonal components.",{tags:["ml","dimension"]}],
        ["Dummy models","Simple baselines to beat.",{tags:["ml","baseline"]}],
        ["Metrics (acc/MAE)","Common scores for tasks.",{tags:["ml","metrics"]}]
      ],
      Medium: [
        ["Random forest","Bagged trees with feature randomness.",{tags:["ml","tree","ensemble"]}],
        ["Gradient boosting","Additive trees reducing residuals.",{tags:["ml","tree","boosting"]}],
        ["SVM (kernel)","Max-margin classifier with kernels.",{tags:["ml","svm"]}],
        ["k-means","Cluster by centroid distance.",{tags:["ml","clustering"]}],
        ["PCA","Unsupervised dimensionality reduction.",{tags:["ml","dimension"]}],
        ["DBSCAN","Density-based clustering.",{tags:["ml","clustering"]}],
        ["Gaussian Mixtures","Probabilistic clustering with EM.",{tags:["ml","clustering"]}],
        ["Elastic Net","Linear model with L1/L2 mix.",{tags:["ml","regularization"]}],
        ["AdaBoost","Boosting by reweighting errors.",{tags:["ml","boosting"]}],
        ["CatBoost","Categorical-aware gradient boosting.",{tags:["ml","boosting"]}]
      ],
      Hard: [
        ["XGBoost vs LightGBM","Histogram bins; leaf-wise vs level-wise growth.",{tags:["ml","boosting","compare"]}],
        ["LSTM/GRU","Recurrent units with gates.",{tags:["ml","rnn"]}],
        ["SHAP values","Shapley-based feature attributions.",{tags:["ml","explain"]}],
        ["Bayesian optimization","Global HPO via surrogate models.",{tags:["ml","hpo"]}],
        ["Transformer encoders","Self-attention for sequences/tabular.",{tags:["ml","transformer"]}],
        ["AutoML","Systematic model/tuning search.",{tags:["ml","automation"]}],
        ["Stacking/blending","Meta-ensembles combining models.",{tags:["ml","ensemble"]}],
        ["Calibration (Platt/Isotonic)","Map scores to probabilities.",{tags:["ml","calibration"]}],
        ["Meta-learning","Learn to learn across tasks.",{tags:["ml","metalearn"]}],
        ["Causal forests","Heterogeneous treatment effects.",{tags:["ml","causal"]}]
      ]
    },
    "MLOps": {
      Easy: [
        ["CI/CD","Automate build/test/deploy for ML.",{tags:["mlops","cicd"]}],
        ["Model registry","Store versions/lineage/metadata.",{tags:["mlops","registry"]}],
        ["Feature store","Consistent offline/online features.",{tags:["mlops","features"]}],
        ["Data versioning","Track datasets across runs.",{tags:["mlops","data"]}],
        ["Monitoring & drift","Watch performance/data drift.",{tags:["mlops","monitoring"]}],
        ["Experiment tracking","Runs, params, metrics, artifacts.",{tags:["mlops","tracking"]}],
        ["Artifact storage","Persist models/datasets.",{tags:["mlops","artifacts"]}],
        ["Reproducible envs","Pin deps via conda/pip/containers.",{tags:["mlops","env"]}],
        ["Infrastructure as Code","Manage infra declaratively.",{tags:["mlops","iac"]}],
        ["Model serving (basics)","Batch or real-time prediction APIs.",{tags:["mlops","serving"]}]
      ],
      Medium: [
        ["Canary deployment","Gradually shift traffic to a new model.",{tags:["mlops","deploy"]}],
        ["Shadow deployment","Run new model in parallel.",{tags:["mlops","deploy"]}],
        ["A/B testing","Compare variants on randomized traffic.",{tags:["mlops","experiment"]}],
        ["Lineage","Trace data→features→model→predictions.",{tags:["mlops","lineage"]}],
        ["Containers","Portable runtime with pinned deps.",{tags:["mlops","containers"]}],
        ["Blue/Green deployment","Switch between two identical stacks.",{tags:["mlops","deploy"]}],
        ["Pipelines (DAGs)","Pipeline as code with retries.",{tags:["mlops","pipeline"]}],
        ["Secrets management","Vault/KMS/SM for tokens/keys.",{tags:["mlops","security"]}],
        ["Rollback strategy","Safe revert on regression.",{tags:["mlops","deploy"]}],
        ["Idempotent jobs","Safe retries without duplicates.",{tags:["mlops","reliability"]}]
      ],
      Hard: [
        ["Online vs batch inference","Per-request latency vs scheduled jobs.",{tags:["mlops","serving"]}],
        ["Concept drift detection","Detect change in P(y|x).",{tags:["mlops","monitoring"]}],
        ["Vector DB serving","Similarity search over embeddings.",{tags:["mlops","retrieval"]}],
        ["Feature consistency","Same transforms offline/online.",{tags:["mlops","features"]}],
        ["Orchestrators","Airflow/Argo/Prefect schedule DAGs.",{tags:["mlops","orchestrator"]}],
        ["GPU scheduling/autoscaling","Right-size accelerators to traffic.",{tags:["mlops","gpu"]}],
        ["Model governance","Approvals, audits, PII controls.",{tags:["mlops","governance"]}],
        ["SLOs/SLIs","Latency, freshness, accuracy targets.",{tags:["mlops","reliability"]}],
        ["Multi-armed bandits","Adaptive traffic allocation.",{tags:["mlops","experiment"]}],
        ["Data contracts","Schema/SLOs for producers/consumers.",{tags:["mlops","contracts"]}]
      ]
    },
    "Data Engineering": {
      Easy: [
        ["Data lake vs warehouse","Raw flexible storage vs curated SQL analytics.",{tags:["de","lake","warehouse"]}],
        ["Parquet","Columnar format; compressed efficient scans.",{tags:["de","parquet","columnar"]}],
        ["Partitioning","Split data by keys for pruning.",{tags:["de","partition"]}],
        ["Airflow DAG","Directed acyclic graph of tasks.",{tags:["de","airflow","dag"]}],
        ["Spark vs Pandas","Distributed vs single-node DataFrames.",{tags:["de","spark","pandas"]}],
        ["OLTP vs OLAP","Transactional vs analytical systems.",{tags:["de","oltp","olap"]}],
        ["Star vs snowflake schema","Dimensional models for BI.",{tags:["de","modeling"]}],
        ["Batch window","Time box for periodic processing.",{tags:["de","batch"]}],
        ["Idempotent loads","Safe re-runs without duplicates.",{tags:["de","reliability"]}],
        ["SQL vs ELT","Transform in warehouse using SQL-first.",{tags:["de","elt"]}]
      ],
      Medium: [
        ["Kafka","Distributed log for event streaming.",{tags:["de","kafka","stream"]}],
        ["Batch vs streaming","Periodic jobs vs near-real-time.",{tags:["de","batch","stream"]}],
        ["Schema evolution","Handle field changes via metadata.",{tags:["de","schema"]}],
        ["Backfill","Recompute historical data.",{tags:["de","backfill"]}],
        ["Z-order clustering","File ordering to improve pruning.",{tags:["de","layout"]}],
        ["Change Data Capture (CDC)","Replicate DB changes downstream.",{tags:["de","cdc"]}],
        ["Watermarking","Bound lateness for out-of-order events.",{tags:["de","stream"]}],
        ["Bucketing","Hash-group files for joins.",{tags:["de","layout"]}],
        ["Cost-based optimizer","Plans based on statistics.",{tags:["de","optimizer"]}],
        ["Orchestration vs scheduling","Dependencies vs time triggers.",{tags:["de","orchestrator"]}]
      ],
      Hard: [
        ["Exactly-once processing","Avoid duplicates via idempotency/transactions.",{tags:["de","reliability"]}],
        ["Delta Lake ACID","Transactional lakes with time travel.",{tags:["de","delta","acid"]}],
        ["Late data","Handle out-of-order via windows/watermarks.",{tags:["de","stream"]}],
        ["Bloom filters","Fast membership tests to skip reads.",{tags:["de","index"]}],
        ["Compaction","Coalesce small files into larger ones.",{tags:["de","layout"]}],
        ["Skew handling","Mitigate hot keys via salting.",{tags:["de","perf"]}],
        ["Adaptive query execution","Dynamic stage optimization in Spark.",{tags:["de","spark","optimizer"]}],
        ["Lakehouse design","Unify lakes and warehouses with ACID tables.",{tags:["de","lakehouse"]}],
        ["Vectorized I/O","Batch reads to increase throughput.",{tags:["de","io"]}],
        ["Predicate pushdown & column pruning","Read only needed rows/columns.",{tags:["de","perf"]}]
      ]
    }
  };

  // ---------- Optional: load a compressed bank if provided ----------
  function tryLoadCompressedBank(){
    const node = document.getElementById("bank-lz");
    if (!node) return null;
    try {
      const raw = node.textContent.trim();
      if (!raw) return null;
      const json = LZString.decompressFromBase64(raw);
      return JSON.parse(json);
    } catch { return null; }
  }

  // Build per-topic/level items with IDs
  const bank = {};
  const SOURCE = tryLoadCompressedBank() || BANK; // prefer embedded compressed bank if present
  for (const t of TOPICS) {
    bank[t] = {};
    for (const L of LEVELS) {
      bank[t][L] = (SOURCE[t]?.[L] || []).map(([term,desc,meta],i)=>({
        id: `${t}-${L}-${i}`, topic:t, level:L, term, desc, meta: meta || {}
      }));
    }
  }

  // ---------- State ----------
  let state = {
    currentTopic: "Python",
    currentLevel: "Easy",
    streaks: {},       // {topic:{level:n}}
    counters: {},      // {topic:{level:{correct,total}}}
    history: [],       // recent answers [{topic,level,correct,qid,ts}]
    recentIds: {}      // reduce repeats {topic|level:[ids]}
  };

  // ---------- Utils ----------
  const $ = (s,r=document)=>r.querySelector(s);
  const $all = (s,r=document)=>[...r.querySelectorAll(s)];
  function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
  function loadState(){ const raw=localStorage.getItem(STORAGE_KEY); if (raw) try{ state=Object.assign(state,JSON.parse(raw)); }catch{} }
  function ensureTL(obj,t,l,init){ if(!obj[t]) obj[t]={}; if(!obj[t][l]) obj[t][l]=init; }
  function toast(html,variant="info",ms=2400){
    const host=$("#toastHost"); const d=document.createElement("div");
    d.className="card p-3 pop border-l-4 "+(variant==="success"?"border-l-green-500":variant==="warn"?"border-l-amber-500":"border-l-indigo-500");
    d.innerHTML=html; host.appendChild(d); setTimeout(()=>d.remove(),ms);
  }
  function rngPick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

  function getStreak(t,l){ ensureTL(state.streaks,t,l,0); return state.streaks[t][l]; }
  function setStreak(t,l,v){ ensureTL(state.streaks,t,l,0); state.streaks[t][l]=Math.max(0,v); }
  function incCounter(t,l,c){ ensureTL(state.counters,t,l,{correct:0,total:0}); state.counters[t][l].total++; if(c) state.counters[t][l].correct++; }
  function accuracy(t,l){ const c=state.counters[t]?.[l]||{correct:0,total:0}; return c.total?c.correct/c.total:0; }

  // ---------- Template helpers ----------
  function sampleK(arr, k, pred = () => true) {
    const pool = arr.filter(pred);
    const out = [];
    while (out.length < k && pool.length) {
      const i = Math.floor(Math.random()*pool.length);
      out.push(pool.splice(i,1)[0]);
    }
    return out;
  }
  function hasAllTags(item, tagset) {
    const t = (item.meta?.tags) || [];
    return tagset.every(x => t.includes(x));
  }
  function scenarioFromTags(term, tags) {
    const map = {
      storage: "store large amounts of data",
      object: "get object-based access",
      durable: "achieve extreme durability",
      http: "serve content over the web",
      serverless: "avoid managing servers",
      stream: "ingest real-time events",
      queue: "decouple components via queues",
      kubernetes: "orchestrate containers with Kubernetes",
      sql: "analyze with standard SQL",
      nosql: "scale with low-latency NoSQL",
      redis: "cache hot data in memory",
      warehouse: "analyze at warehouse scale"
    };
    const bits = tags.map(t => map[t]).filter(Boolean).slice(0,3);
    if (!bits.length) return `Which option best fits the described need?`;
    return `You need to ${bits.join(", ")}. Which option fits best?`;
  }

  // ---------- Procedural question builder ----------
  // Styles:
  //  A) desc->term
  //  B) term->desc
  //  C) scenario (tag-based)
  //  D) truefalse (one true, three mismatched)
  //  E) not-true (three correct statements + one mismatched)
  function makeQuestion(topic, level){
    const pool = bank[topic][level];
    if (!pool || pool.length===0) return null;

    // avoid immediate repeats
    const key = `${topic}|${level}`;
    const recent = state.recentIds[key] || [];
    const candidates = pool.filter(q => !recent.includes(q.id));
    const target = (candidates.length>0 ? rngPick(candidates) : rngPick(pool));

    const others = pool.filter(q => q.id !== target.id);
    const hasTags = !!(target.meta?.tags?.length);
    const styles = hasTags ? ["desc->term","term->desc","scenario","truefalse","not-true"] : ["desc->term","term->desc"];
    const style = rngPick(styles);

    let stem, choices, answerIndex, explanation;

    if (style === "desc->term") {
      const distract = sampleK(others, 3);
      stem = `(${topic} / ${level}) Which option best matches: "${target.desc}"?`;
      choices = shuffle([target.term, ...distract.map(d=>d.term)]);
      answerIndex = choices.indexOf(target.term);
      explanation = `Correct: ${target.term} — ${target.desc}`;
    }
    else if (style === "term->desc") {
      const distract = sampleK(others, 3);
      stem = `(${topic} / ${level}) What does "${target.term}" most closely mean?`;
      choices = shuffle([target.desc, ...distract.map(d=>d.desc)]);
      answerIndex = choices.indexOf(target.desc);
      explanation = `Correct: ${target.term} — ${target.desc}`;
    }
    else if (style === "scenario") {
      const tags = (target.meta?.tags || []).slice(0,3);
      const distract = sampleK(others, 3, d => !hasAllTags(d, tags));
      stem = `(${topic} / ${level}) ${scenarioFromTags(target.term, tags)}`;
      choices = shuffle([target.term, ...distract.map(d=>d.term)]);
      answerIndex = choices.indexOf(target.term);
      explanation = `Why ${target.term}? ${target.desc}`;
    }
    else if (style === "truefalse") {
      const good = `${target.term} — ${target.desc}`;
      const wrongs = sampleK(others, 3).map(d => `${d.term} — ${target.desc}`); // mismatched defs
      stem = `(${topic} / ${level}) Which statement is TRUE?`;
      choices = shuffle([good, ...wrongs]);
      answerIndex = choices.indexOf(good);
      explanation = `Only "${target.term} — ${target.desc}" is accurate for this concept.`;
    }
    else { // "not-true"
      const good3 = sampleK(others, 3).map(d => `${d.term} — ${d.desc}`);
      const wrong = `${target.term} — ${rngPick(others).desc}`; // mismatched definition
      stem = `(${topic} / ${level}) Which statement is NOT true?`;
      choices = shuffle([wrong, ...good3]);
      answerIndex = choices.indexOf(wrong);
      explanation = `The mismatched statement pairs ${target.term} with the wrong description.`;
    }

    // track recently asked (cap 18 to avoid repeats while keeping memory small)
    recent.unshift(target.id); state.recentIds[key] = recent.slice(0,18);

    return { id: target.id + "|" + style, topic, level, stem, choices, answerIndex, explanation };
  }

  function shuffle(a){ const x=[...a]; for(let i=x.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [x[i],x[j]]=[x[j],x[i]]; } return x; }

  // ---------- UI ----------
  let currentQ = null;
  function renderTopics(){
    const host=$("#topicList"); host.innerHTML="";
    for (const t of TOPICS){
      const btn=document.createElement("button");
      btn.className="btn justify-between";
      const overall=(LEVELS.map(L=>accuracy(t,L)).reduce((a,b)=>a+b,0)/3*100)|0;
      btn.innerHTML=`<span>${t}</span><span class="chip">${overall}%</span>`;
      btn.onclick=()=>{ state.currentTopic=t; saveState(); updateContext(); nextQuestion(); };
      host.appendChild(btn);
    }
  }
  function updateContext(){
    $("#currentTopicBadge").textContent="Topic: "+state.currentTopic;
    $("#currentLevelBadge").textContent="Level: "+state.currentLevel;
    $("#streakVal").textContent=getStreak(state.currentTopic,state.currentLevel);
    $all("#difficultyBadges .chip").forEach(el=>{
      el.classList.toggle("bg-indigo-600/10", el.dataset.level===state.currentLevel);
      el.classList.toggle("border-indigo-600", el.dataset.level===state.currentLevel);
      el.onclick=()=>{ state.currentLevel=el.dataset.level; saveState(); updateContext(); nextQuestion(); };
    });
  }
  function renderQuestion(q){
    $("#questionText").textContent=q.stem;
    const ul=$("#choices"); ul.innerHTML="";
    q.choices.forEach((c,i)=>{
      const li=document.createElement("li");
      li.innerHTML=`<button class="w-full text-left btn" data-index="${i}">
        <span class="kbd mr-2">${i+1}</span>${c}
      </button>`;
      li.querySelector("button").onclick=()=>answer(i);
      ul.appendChild(li);
    });
    $("#explanationBox").classList.add("hidden");
    $("#btnExplain").disabled=true;
  }
  function nextQuestion(){
    const q=makeQuestion(state.currentTopic,state.currentLevel);
    if(!q){ $("#questionText").textContent="No questions available."; $("#choices").innerHTML=""; return; }
    currentQ=q; renderQuestion(q);
  }
  function answer(idx){
    if(!currentQ) return;
    const correct=(idx===currentQ.answerIndex);
    incCounter(currentQ.topic,currentQ.level,correct);
    if(correct){ setStreak(currentQ.topic,currentQ.level,getStreak(currentQ.topic,currentQ.level)+1); }
    else { setStreak(currentQ.topic,currentQ.level,0); }
    promoteOrDemote(currentQ.topic,currentQ.level,correct);

    // UI feedback
    $all("#choices button").forEach((b,i)=>{
      b.disabled=true;
      if(i===currentQ.answerIndex) b.classList.add("bg-green-600","text-white","border-green-600");
      if(i===idx && !correct) b.classList.add("bg-red-600","text-white","border-red-600");
    });

    // history + save + reports
    state.history.unshift({topic:currentQ.topic, level:currentQ.level, correct, qid:currentQ.id, ts:Date.now()});
    state.history=state.history.slice(0,500);
    saveState(); refreshReports();

    // explanation
    $("#btnExplain").disabled=false;
    $("#explanationBox").classList.remove("hidden");
    $("#explanationText").textContent=currentQ.explanation;
    updateContext();
  }
  function promoteOrDemote(topic, level, correct){
    const idx=LEVELS.indexOf(level);
    if(correct){
      const s=getStreak(topic,level);
      if(MOTIVATION_STREAKS.includes(s)){
        toast(`<div class="font-semibold">Nice streak</div><div class="text-sm">You hit ${s} in ${topic} (${level}).</div>`,"success");
      }
      if(s>=PROMOTION_STREAK && idx<LEVELS.length-1){
        state.currentLevel=LEVELS[idx+1];
        toast(`<div class="font-semibold">Promoted to ${state.currentLevel}</div><div class="text-sm">Harder questions unlocked in ${topic}.</div>`,"success");
        setStreak(topic,state.currentLevel,0);
      }
    } else {
      if(idx>0){
        state.currentLevel=LEVELS[idx-1];
        toast(`<div class="font-semibold">Demoted to ${state.currentLevel}</div><div class="text-sm">Reinforce ${topic} fundamentals and climb back.</div>`,"warn");
      }
    }
  }

  // ---------- Reports ----------
  function refreshReports(){
    const topicAcc=TOPICS.map(t=>{
      const total=LEVELS.reduce((s,L)=>s+((state.counters[t]?.[L]?.total)||0),0);
      const correct=LEVELS.reduce((s,L)=>s+((state.counters[t]?.[L]?.correct)||0),0);
      return total?(correct/total*100):0;
    });

    // Table
    const tbody=$("#reportTable"); tbody.innerHTML="";
    for(const t of TOPICS){
      const row=document.createElement("tr");
      row.className="border-t border-zinc-200 dark:border-zinc-800";
      const cells=[t]
        .concat(LEVELS.map(L=>{
          const c=state.counters[t]?.[L]||{correct:0,total:0};
          const pct=c.total?Math.round(c.correct/c.total*100):0;
          return `${pct}% (${c.correct}/${c.total})`;
        }))
        .concat((()=>{
          const total=LEVELS.reduce((s,L)=>s+((state.counters[t]?.[L]?.total)||0),0);
          const correct=LEVELS.reduce((s,L)=>s+((state.counters[t]?.[L]?.correct)||0),0);
          return total?`${Math.round(correct/total*100)}% (${correct}/${total})`:"0% (0/0)";
        })());
      row.innerHTML=cells.map((c,i)=>`<td class="py-2 ${i===0?"font-medium":""}">${c}</td>`).join("");
      tbody.appendChild(row);
    }

    // Charts
    const ctx1=$("#chartTopic"); if (window.chartTopic) window.chartTopic.destroy();
    window.chartTopic=new Chart(ctx1,{type:"bar",data:{labels:TOPICS,datasets:[{label:"Accuracy %",data:topicAcc}]},options:{responsive:true,scales:{y:{suggestedMin:0,suggestedMax:100}}}});
    const levelSets=LEVELS.map(L=>({label:L,data:TOPICS.map(t=>{const c=state.counters[t]?.[L]||{correct:0,total:0};return c.total?Math.round(c.correct/c.total*100):0;}),stack:"levels"}));
    const ctx2=$("#chartMatrix"); if (window.chartMatrix) window.chartMatrix.destroy();
    window.chartMatrix=new Chart(ctx2,{type:"bar",data:{labels:TOPICS,datasets:levelSets},options:{responsive:true,scales:{y:{suggestedMin:0,suggestedMax:100},x:{stacked:true},yAxes:{stacked:true}}}});
  }

  // ---------- Offline Study Plan ----------
  const LINKS = {
    AWS:["https://docs.aws.amazon.com","https://aws.amazon.com/architecture/","https://catalog.workshops.aws/"],
    GCP:["https://cloud.google.com/docs","https://cloud.google.com/architecture","https://cloudskillsboost.google/"],
    Python:["https://docs.python.org/3/","https://realpython.com/","https://docs.python.org/3/library/index.html"],
    SQL:["https://www.postgresql.org/docs/","https://dev.mysql.com/doc/","https://www.sqlite.org/docs.html"],
    AI:["https://scikit-learn.org/stable/","https://developers.google.com/machine-learning/crash-course","https://pytorch.org/tutorials/"],
    ML:["https://scikit-learn.org/stable/user_guide.html","https://xgboost.readthedocs.io/","https://lightgbm.readthedocs.io/"],
    MLOps:["https://ml-ops.org/","https://docs.dagster.io/","https://airflow.apache.org/docs/"],
    "Data Engineering":["https://spark.apache.org/docs/latest/","https://delta.io/","https://kafka.apache.org/documentation/"]
  };
  function offlinePlan(){
    const recent=state.history.slice(0,80);
    const score={};
    for(const h of recent){
      const k=`${h.topic}|${h.level}`;
      if(!score[k]) score[k]={correct:0,total:0,topic:h.topic,level:h.level};
      score[k].total++; if(h.correct) score[k].correct++;
    }
    const entries=Object.values(score).map(x=>({...x,acc:x.total?x.correct/x.total:0}));
    entries.sort((a,b)=>a.acc-b.acc);
    const weak=entries.slice(0,3);
    const lines=weak.length?weak.map(w=>`- ${w.topic} @ ${w.level}: ${(w.acc*100|0)}% (${w.correct}/${w.total})`):["- Not enough data yet (answer some questions)."];
    let html=`<h3 class='text-base font-semibold'>Your 7-Day Plan</h3><p class='text-sm text-zinc-500'>Generated locally from your weakest areas.</p>`;
    html+=`<p class='mt-2'><span class='font-semibold'>Focus:</span></p><ul class='list-disc ml-6'>${lines.map(x=>`<li>${x}</li>`).join("")}</ul>`;
    html+=`<p class='mt-3'>Daily (30–45 min):</p><ul class='list-disc ml-6'>
      <li>10 min: Review notes/flashcards for the weak topic & difficulty.</li>
      <li>15–20 min: Answer 15–25 questions in this app at the current level.</li>
      <li>10–15 min: Read one official resource.</li>
    </ul>`;
    if(weak.length){
      const tset=[...new Set(weak.map(w=>w.topic))];
      html+=`<p class='mt-3 font-semibold'>Resources:</p>`;
      html+=tset.map(t=>{const L=(LINKS[t]||[]).map(u=>`<a class="link" target="_blank" rel="noopener">${u}</a>`).join(" • "); return `<p><span class='font-medium'>${t}:</span> ${L}</p>`;}).join("");
    } else {
      html+=`<p class='mt-3'>Start with any topic’s Easy level. Suggested links: ${LINKS.Python.map(u=>`<a class="link" target="_blank" rel="noopener">${u}</a>`).join(" • ")}</p>`;
    }
    $("#studyPlanBox").innerHTML=html;
  }

  // ---------- Export / Import (progress only) ----------
  function download(filename, text){
    const a=document.createElement("a");
    a.href=URL.createObjectURL(new Blob([text],{type:"application/json"}));
    a.download=filename; a.click(); URL.revokeObjectURL(a.href);
  }
  $("#btnExport").onclick=()=>{ download("quiz-progress.json", JSON.stringify(state,null,2)); toast("Progress exported as JSON.","success"); };
  $("#btnImport").onclick=()=>$("#fileImport").click();
  $("#fileImport").addEventListener("change", async (e)=>{
    const f=e.target.files[0]; if(!f) return;
    try{ const txt=await f.text(); const payload=JSON.parse(txt); state=Object.assign(state,payload); saveState(); bootstrap(); toast("Progress imported.","success"); }
    catch{ toast("Invalid JSON file.","warn"); }
    e.target.value="";
  });

  // ---------- Events ----------
  $("#btnNext").onclick=nextQuestion;
  $("#btnExplain").onclick=()=>{ if(currentQ){ $("#explanationBox").classList.remove("hidden"); $("#explanationText").textContent=currentQ.explanation; } };
  $("#btnReportsTab").onclick=()=>{ refreshReports(); window.scrollTo({top:document.body.scrollHeight, behavior:"smooth"}); };
  $("#btnReset").onclick=()=>{ state.streaks={}; state.history=[]; saveState(); updateContext(); toast("Session streaks cleared.","info"); };
  $("#btnHardReset").onclick=()=>{ localStorage.removeItem(STORAGE_KEY); location.reload(); };
  $("#btnStudyPlan").onclick=()=>{ offlinePlan(); window.scrollTo({top:document.body.scrollHeight, behavior:"smooth"}); };
  $("#btnRefreshPlan").onclick=()=> offlinePlan();
  document.addEventListener("keydown",(e)=>{
    if(["1","2","3","4"].includes(e.key)){
      const idx=Number(e.key)-1; const btn=document.querySelector(`#choices button[data-index="${idx}"]`); if(btn && !btn.disabled) btn.click();
    }
  });

  // ---------- Bootstrap ----------
  function bootstrap(){
    if(window.lucide?.createIcons) window.lucide.createIcons();
    renderTopics(); updateContext(); refreshReports(); nextQuestion();
  }
  loadState(); bootstrap();
  </script>
</body>
</html>


